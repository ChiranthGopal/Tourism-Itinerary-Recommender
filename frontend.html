<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="http://localhost/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="http://localhost/Project/checkbox_bootstrap_css_part_html.css">
    <script src="http://localhost/jquery-2.2.4.js"></script>
    <script src="http://localhost/bootstrap/js/bootstrap.min.js"></script>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <style>
    #map {
    height: 480px;
        width : 800px;
    }
  /* Optional: Makes the sample page fill the window. */
  html, body {
    background-color:black,
    height: 100%;
    margin: 0px;
    padding-left: 20px;
    padding-right: 0px;
  }
  /* to remove the gap between manu and map*/
  .row.no-gutter {
    margin-left: 0;
    margin-right: 0;
  }

  .row.no-gutter [class*='col-']:not(:first-child),
  .row.no-gutter [class*='col-']:not(:last-child) {
    padding-right: 0;
    padding-left: 0;
  }
  body{
  padding-left:0,
  padding-right: 0
  }
  tr:hover 
  {
    background-color:#93b8ba;
  }
  div#padding_to_table
    {
      padding-right: 3cm;
      padding-left: 3cm;
    }
  td,th
    {   
      text-align:center;
    }
    </style>

</head>
<body onload="init()">
  <div class = "horizontal bar">
      <nav class="navbar navbar-inverse">
          <div class="container-fluid">
            <div class="navbar-header">
                <a class="navbar-brand">Tourism</a>
            </div>
            <ul class="nav navbar-nav">
                <li class="active"><a  >Home</a></li>
                <li><a  >Page 1</a></li>
                <li><a  >Page 2</a></li>
                <li><a  >Page 3</a></li>
            </ul>
          </div>
      </nav>
    </div>


    <div class="container-fluid" style="margin-left:0px padding-left:0px">
        <div class="row">
        <!--<div class="col-md-2">
        <div class="sidebar-nav">
          <div class="navbar navbar-default" role="navigation">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".sidebar-navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              <span class="visible-xs navbar-brand">Sidebar menu</span>
            </div>
            <div class="navbar-collapse collapse sidebar-navbar-collapse">
              <ul class="nav navbar-nav">
                
                <li id="Sights" class="active"><a  >Sights & Landmarks</a></li>
                <li><a id="Nature" onclick="show_places()">Nature & Parks</a></li>
                <li><a id="Outdoor" onclick="show_places()">Outdoor Activities</a></li>
                <li><a id="zoos" onclick="show_places()">Zoos & Aquariums</a></li>
                <li><a id="Museums" onclick="show_places()">Museums</a></li><br/>
                <li><a  id="Shopping" onclick="show_places()">Shopping   </a></li>
                <li><a  id="Tours" onclick="show_places()">Tours</a></li>
                <li><a  id="Food" onclick="show_places()">Food & Drink</a></li>
                <li><a  id="Spas" onclick="show_places()">Spas & Wellness</a></li>
                <li><a  id="Water" onclick="show_places()">Water & Parks</a></li>
                <li><a  id="Classes" onclick="show_places()">Classes & Workshops</a></li>
                <li><a  id="Fun" onclick="show_places()">Fun & Games</a></li>
                <li><a  id="Conerts" onclick="show_places()">Conerts & shows</a></li>
                <li><a  id="Transportaion" onclick="show_places()">Transportaion</a></li>
                <li><a  id="Nightlife" onclick="show_places()">Nightlife</a></li>
                
              </ul>
            </div>-->
            <div class="col-md-3">
            <div class="panel panel-default">
                <ul class="list-group">
                    <li class="list-group-item">
                         Historical Places and Monuments
                        <div class="material-switch pull-right">
                            <input id="historical" name="someSwitchOption001" type="checkbox" onchange="register_catagory()"/>
                            <label for="historical" class="label-primary"></label>
                        </div>
                    </li>
                    <li class="list-group-item">
                         Points of Interest 
                        <div class="material-switch pull-right">
                            <input id="poi" name="someSwitchOption001" type="checkbox" onchange="register_catagory()"/>
                            <label for="poi" class="label-primary"></label>
                        </div>
                    </li>
                    <li class="list-group-item">
                         Religious Sites
                        <div class="material-switch pull-right">
                            <input id="religious" name="someSwitchOption001" type="checkbox" onchange="register_catagory()"/>
                            <label for="religious" class="label-primary"></label>
                        </div>
                    </li>
                    <li class="list-group-item">
                        Nature & Parks
                        <div class="material-switch pull-right">
                            <input id="nature" name="someSwitchOption001" type="checkbox" onchange="register_catagory()"/>
                            <label for="nature" class="label-primary"></label>
                        </div>
                    </li>
                    <li class="list-group-item">
                        Outdoor Activities
                        <div class="material-switch pull-right">
                            <input id="outdoor" name="someSwitchOption001" type="checkbox" onchange="register_catagory()"/>
                            <label for="outdoor" class="label-primary"></label>
                        </div>
                    </li>
                    <li class="list-group-item">
                        Zoos & Aquariums
                        <div class="material-switch pull-right">
                            <input id="zoo" name="someSwitchOption001" type="checkbox" onchange="register_catagory()"/>
                            <label for="zoo" class="label-primary"></label>
                        </div>
                    </li>
                    <li class="list-group-item">
                        Museums
                        <div class="material-switch pull-right">
                            <input id="museums" name="someSwitchOption001" type="checkbox" onchange="register_catagory()"/>
                            <label for="museums" class="label-primary"></label>
                        </div>
                    </li>
                    <li class="list-group-item">
                        Shopping
                        <div class="material-switch pull-right">
                            <input id="shopping" name="someSwitchOption001" type="checkbox" onchange="register_catagory()"/>
                            <label for="shopping" class="label-primary"></label>
                        </div>
                    </li>
                    <li class="list-group-item">
                        Food & Drink
                        <div class="material-switch pull-right">
                            <input id="food" name="someSwitchOption001" type="checkbox" onchange="register_catagory()"/>
                            <label for="food" class="label-primary"></label>
                        </div>
                    </li>
                    <li class="list-group-item">
                        Spas & Wellness
                        <div class="material-switch pull-right">
                            <input id="spas" name="someSwitchOption001" type="checkbox" onchange="register_catagory()"/>
                            <label for="spas" class="label-primary"></label>
                        </div>
                    </li>
                    <li class="list-group-item">
                        Water & Parks
                        <div class="material-switch pull-right">
                            <input id="water" name="someSwitchOption001" type="checkbox" onchange="register_catagory()"/>
                            <label for="water" class="label-primary"></label>
                        </div>
                    </li>
                    <li class="list-group-item">
                        Conerts & shows
                        <div class="material-switch pull-right">
                            <input id="concerts" name="someSwitchOption001" type="checkbox" onchange="register_catagory()"/>
                            <label for="concerts" class="label-primary"></label>
                        </div>
                    </li>
                    <li class="list-group-item">
                        NightLife
                        <div class="material-switch pull-right">
                            <input id="night" name="someSwitchOption001" type="checkbox" onchange="register_catagory()"/>
                            <label for="night" class="label-primary"></label>
                        </div>
                    </li>
                    <!-- <li class="list-group-item"> 
                        <input type="button" onclick="show_places()" value="Submit Preferences">
                    </li>-->

                </ul>
            </div>            
        </div>



    <div class ="col-md-9">
    <div id="map">
      
    </div>
    </div>
    </div>
    </div>
        <div id="padding_to_table">
            <table class="table table-bordered" id="table" >
                  
            </table>
        </div>
    </div>
    <div id="current">
    </div>
    </div>
    <script>
    category_timer=null;
    markers = [];
    green_marker = null;

    function init()
    {
    historical = document.getElementById('historical');
    religious = document.getElementById('religious');
    poi = document.getElementById('poi');
    nature = document.getElementById('nature');
    outdoor = document.getElementById('outdoor');
    shopping = document.getElementById('shopping');
    museums = document.getElementById('museums');
    water = document.getElementById('water');
    zoo = document.getElementById('zoo');
    spas = document.getElementById('spas');
    food = document.getElementById('food');
    night = document.getElementById('night');
    concerts = document.getElementById('concerts');
    }

    function register_catagory() 
    {
        if(category_timer!=null)
        {
            clearTimeout(category_timer);
        }  
        category_timer=setTimeout(show_places,2000);
    }

  //Sets markers on the map
    function setMapOnAll(map) {
        for (var i = 0; i < markers.length; i++) {
      markers[i].setMap(map);
        }
    }

      // Removes the markers from the map, but keeps them in the array.
    function clearMarkers() {
        setMapOnAll(null);
    }

      // Shows any markers currently in the array.
    function showMarkers() {
        setMapOnAll(map);
    }

      // Deletes all markers in the array by removing references to them.
    function deleteMarkers() {
        clearMarkers();
        markers = [];
    }
  
    function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
      center: {lat: 12.29, lng: 76.64},
      zoom: 12
        });
        var infoWindow = new google.maps.InfoWindow({map: map});

        // below line checks for users geo location if it is found then it sets  center of the map to users current position(setting to mysore for now)
        if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(function(position) {
        var pos = {
          //lat: position.coords.latitude,
          //lng: position.coords.longitude
          lat: 12.29, lng: 76.64
        };

          
        //infoWindow.setPosition(pos);
        //infoWindow.setContent('Location found.');
         marker = new google.maps.Marker
        (
          {
            position:pos,
            map:map,
           //modified  part
            draggable:true,
            icon:"http://maps.google.com/mapfiles/ms/icons/blue-dot.png"//11111111111111111111111111111111111111111111
          }
        );



        //modified part this part is to locate the new lat long of the dragged part

        var t= new google.maps.event.addListener(marker, 'dragend', function(evt){
            document.getElementById('current').innerHTML = '<p>Marker dropped: Current Lat: ' + evt.latLng.lat().toFixed(3) + ' Current Lng: ' + evt.latLng.lng().toFixed(3) + '</p>';
        });

        var tt =  new google.maps.event.addListener(marker, 'dragstart', function(evt){
            document.getElementById('current').innerHTML = '<p>Currently dragging marker...</p>';
        });





        
        map.setCenter(pos);
      }, function() {
        handleLocationError(true, infoWindow, map.getCenter());
      });
        }
    else {
          // Browser doesn't support Geolocation
          handleLocationError(false, infoWindow, map.getCenter());
        }

    }

    function handleLocationError(browserHasGeolocation, infoWindow, pos) {
        infoWindow.setPosition(pos);
        infoWindow.setContent(browserHasGeolocation ?
                              'Error: The Geolocation service failed.' :
                              'Error: Your browser doesn\'t support geolocation.');
    }

  // Check selected categories and send a request to server
    function show_places(event) 
    {
    document.getElementById("table").innerHTML = "";
    clearMarkers();
    //modified part

    toSend = "";
    if(historical.checked==true)
     toSend = toSend + "Historic Places & Monuments"+ ";";
    if(religious.checked==true)
     toSend = toSend + "Religious Sites"+ ";";
    if(poi.checked==true)
     toSend = toSend + "Points of Interest & Landmarks"+ ";";
    if(nature.checked==true)
     toSend = toSend + "Nature & Parks"+ ";";
    if(outdoor.checked==true)
     toSend = toSend + "Outdoor Activities"+ ";";
    if(shopping.checked==true)
     toSend = toSend + "Shopping"+ ";";
    if(museums.checked==true)
     toSend = toSend + "Museums"+ ";";
    if(water.checked==true)
     toSend = toSend + "Water & Amusement Parks"+ ";";
    if(spas.checked==true)
     toSend = toSend + "Spas & Wellness"+ ";";
    if(zoo.checked==true)
     toSend = toSend + "Zoos & Aquariums"+ ";";
    if(food.checked==true)
     toSend = toSend + "Food & Drink"+ ";";
    if(night.checked==true)
     toSend = toSend + "Nightlife"+ ";";
    if(concerts.checked==true)
     toSend = toSend + "Concerts & Shows"+ ";";

    console.log(toSend);

    xhr = new XMLHttpRequest();
    xhr.onreadystatechange = updateinfo;
    xhr.open("GET","http://localhost/Project/retrieve.php?category="+encodeURIComponent(toSend),true);
    xhr.send(); 

    }
      
    // Changes the color of the marker on map from red to green
    function find_marker(event)
    {
        for (var i = markers.length - 1; i >= 0; i--)
        {
      //markers[i].setIcon('http://maps.google.com/mapfiles/ms/icons/green-dot.png');
      console.log(event.target.parentNode.id);
      if(markers[i]['title']==event.target.parentNode.id)
      {
        if(green_marker==null)
        {
          //console.log('green marker is null');
          markers[i].setIcon('http://maps.google.com/mapfiles/ms/icons/green-dot.png');
          green_marker=markers[i];
          //console.log(green_marker);
          break;
        }
        else
        {
          //console.log('green marker is not null');
          green_marker.setIcon('http://maps.google.com/mapfiles/ms/icons/red-dot.png');
          markers[i].setIcon('http://maps.google.com/mapfiles/ms/icons/green-dot.png');
          green_marker=markers[i];
          break; 
        }
      }
    }
    }
   
        //this function assigns onclick event on each newly created  row in table
  function click_assigner(id)
  {
    row = document.getElementById(id);
    //this while loop will check whether the div element is created or not
    while(true)
    {
      if(row!=null)
      {
        row.addEventListener('click',find_marker,true);
        break;
      }
      else
      {
        row = document.getElementById(id);
        //console.log(row); 
      }
    }
  }

  //func that gets called when get response from backend
    function updateinfo()
    {
    if (xhr.readyState == 4 && xhr.status == 200)
    {
      data = JSON.parse(xhr.responseText);
      console.log(data);

      /* to structure the json object look at line no 154
      */

      //dict to get the min max times based on categories
      categ_times = {}

      categ_times["Religious Sites"] = [1,2]
      categ_times["Historic Places & Monuments"] = [1,3]
      categ_times["Points of Interest & Landmarks"] = [0.5, 1]
      categ_times["Nature & Parks"] = [1.5,2.5]
      categ_times["Outdoor Activities"] = [2.5,3.5]
      categ_times["Zoos & Aquariums"] = [2.5,4]
      categ_times["Museums"] = [1.5,3]
      categ_times["Shopping"] = [1,3]
      categ_times["Food & Drink"] = [1,2]
      categ_times["Spas & Wellness"] = [1,3]
      categ_times["Water & Amusement Parks"] = [3,6]
      categ_times["Concerts & Shows"] = [1.5,3.5]
      categ_times["Nightlife"] = [1,2.5]
      categ_times["Tours"] = [3,4]

      table = document.getElementById("table");

      //creates the heading of the table
      thead=document.createElement("thead");
      tbody=document.createElement("tbody");
      tr = document.createElement("tr");
      chk= document.createElement("th"); 
      nam= document.createElement("th");
      cat= document.createElement("th");
      rat= document.createElement("th");
      rev = document.createElement("th");
      timeSpent = document.createElement("th");
      editTime = document.createElement("th");
      chk.innerHTML = "";
      nam.innerHTML = "Name";
      cat.innerHTML = "Category";
      rat.innerHTML = "Rating";
      rev.innerHTML = "Reviews";
      timeSpent.innerHTML = "Recommended Duration(hrs)";
      editTime.innerHTML = "Edit time";

      tr.appendChild(chk);
      tr.appendChild(nam);
      tr.appendChild(cat);
      tr.appendChild(rat);
      tr.appendChild(rev);
      tr.appendChild(timeSpent);
      tr.appendChild(editTime);
      thead.appendChild(tr);
      table.appendChild(thead);

      for(var i=0;i<data.place.length;i++)
      {
        tr = document.createElement("tr");
        s=i+'';
        tr.setAttribute("id",data.place[i]['place_name']);
        //tr.setAttribute("id",s);
        
        box_chk = document.createElement("td");
        chk = document.createElement("input");
        chk.setAttribute("type","checkbox");
        checkId = "check"+data.place[i]['place_name'];
        chk.setAttribute("id",checkId);
        box_chk.appendChild(chk);
        
        nam= document.createElement("td");
        a = document.createElement('a');
        a.setAttribute('href',data.place[i]['url'])
        //a.setAttribute('href','abc.com');

        //this line causes link to open a new window
        a.setAttribute('target','_blank');
        a.innerHTML=data.place[i]['place_name'];
        //a.innerHTML='palace';
        nam.appendChild(a);

        cat= document.createElement("td");
        cat.innerHTML = data.place[i]['category_name'];

        rat= document.createElement("td");
        rat.innerHTML = data.place[i]['rating'];
        //rat.innerHTML = '4.5';

        rev = document.createElement("td");
        rev.innerHTML = data.place[i]['review'];
        //rev.innerHTML = '1500';

        timeSpent = document.createElement("td");
        timeSpent.innerHTML = data.place[i]['avg_time'];
        //timeSpent.innerHTML = '1.5'

        //small calc for min and max times since avg time is randomly taken from any of the multiple categories but we are getting only one categ from the db and avg time may not fall in its range
        minTime = categ_times[data.place[i]['category_name']][0];
        maxTime = categ_times[data.place[i]['category_name']][1];
        if(data.place[i]['avg_time'] < minTime){
          minTime = data.place[i]['avg_time'];
        }
        else if(data.place[i]['avg_time'] > maxTime){
          maxTime = data.place[i]['avg_time']; 
        }

        box_editTime = document.createElement("td");
        //divMin = document.createElement("div");
        //divMin.innerHTML = minTime;
        editTime = document.createElement("input");
        editTime.setAttribute("type","range");
        slideId = "slide" + i;
        editTime.setAttribute("id",slideId);
        editTime.setAttribute("min",minTime);
        editTime.setAttribute("max",maxTime);
        editTime.setAttribute("value",data.place[i]['avg_time']);
        editTime.setAttribute("step","0.5");
        //divMax = document.createElement("div");
        //divMax.innerHTML = maxTime;
        //box_editTime.appendChild(divMin);
        box_editTime.appendChild(editTime);
        //box_editTime.appendChild(divMax);
        //editTime.setAttribute("onchange",function(){updateRecomTime(data.place[i]['place_name'],this.value);});
        //editTime.setAttribute("oninput",updateRecomTime(this,data.place[i]['place_name'],this.value));
        setTimeout(assign_event,50,slideId);

        tr.appendChild(box_chk);
        tr.appendChild(nam);
        tr.appendChild(cat);
        tr.appendChild(rat);
        tr.appendChild(rev);
        tr.appendChild(timeSpent);
        tr.appendChild(box_editTime);

        tbody.appendChild(tr);

        var pos=
        {
            lat:parseFloat(data.place[i]['latitude']) ,
          //  lat:parseFloat('12.56'+i) ,
            lng:parseFloat(data.place[i]['longitude']) 
          //  lng:parseFloat('75.89'+i) 
        }

        var marker = new google.maps.Marker({
          position: pos,
          map: map,
          title: data.place[i]['place_name']
          //title: 'palace'
        });
        map.setCenter(pos);
        markers.push(marker);
        timer = setTimeout(click_assigner,50,data.place[i]['place_name']);
      }

      table.appendChild(tbody);

      //add button to calling func to check the checkboxes that are ticked
      but = document.createElement("input");
      but.setAttribute("id","but");
      but.setAttribute("type","button");
      but.setAttribute("value","Choose");
      //but.setAttribute("onclick","checkClick()");
      //does the same as above but with parameters
      but.addEventListener("click", function(event) {
        checkClick(data.place);
        event.preventDefault();
      });
      
      document.body.appendChild(but);
    }
    }
  
  //func for checking checkboxes and and getting places to generate itinerary
  function checkClick(places){
    for(i=0;i<places.length;i++){
      checkId = "check"+places[i]['place_name'];
      if(document.getElementById(checkId).checked)
        console.log(places[i]['place_name']);
    }
  }

    //Intermediate function to bind the slider with the function to change recommended value
    function assign_event(id)
    {
        editTime = document.getElementById(id)
        while(true){
            if(editTime!=null){
                editTime.addEventListener('change',updateRecomTime,true);
                break;
            }
            else
                editTime = document.getElementById(id);       
        }
    }

    //func to update recommended time
    function updateRecomTime(event){
    editTime = document.getElementById(event.target.id);
    tr = document.getElementById(event.target.parentNode.parentNode.id);
    while(true){
      if(typeof(editTime.value) != 'undefined'){
        tr.childNodes[5].innerHTML = editTime.value;
        break;
      }
      else{
        editTime = document.getElementById(event.target.id);
      }
    }
    }
    
    </script>
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDktM5C_FvrETwLyukVTlPfmPCjEwj7UpU&callback=initMap">
    </script>
  </body>
</html>